<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<script src="https://kit.fontawesome.com/4eee35f757.js"></script>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="github.css" type="text/css">
<link rel="stylesheet" href="tutorial.css" type="text/css">
<script defer data-domain="gvwilson.github.io/sys-tutorial" src="https://plausible.io/js/script.js"></script>
<title>The Sudonomicon</title>

  </head>
  <body>
    <nav>
  <div class="row underline">
    <div class="col-2 left">
      <a class="navlink" href="#">Home</a>
    </div>
    <div class="col-10 right">
      <a href="https://github.com/gvwilson/sys-tutorial">repo</a>
      <a href="https://github.com/gvwilson/sys-tutorial/raw/main/sys-tutorial.zip">download</a>
      <a class="navlink" href="bib/">bibliography</a>
      <a class="navlink" href="license/">license</a>
      <a class="navlink" href="conduct/">conduct</a>
      <a class="navlink" href="contributing/">contributing</a>
      <a class="navlink" href="colophon/">colophon</a>
    </div>
  </div>
</nav>

    <main>
      
  <h1>The Sudonomicon</h1>
  <p class="subtitle">Unix Systems for Weary Data Scientists</p>


      <div class="row">
  <div class="col-4 center">
    <img src="advent_05_356-resized.png" alt="cover art by Danielle Navarro" width="80%"/>
  </div>
  <div class="col-8">
    <p>
      Many think they know Unix.
      Few realize that what they know is just a shell.
      Beneath it lie mysteries both bewildering and wonderful:
      ports, processes, permissions,
      files that are not files,
      and components built atop other, older components
      that occasionally rise to the surface like ancient sea creatures believed long extinct.
    </p>
    <p>
      Like such creatures,
      Unix will outlive those who mock it.
      Welcome, then, to a world in which the strange will become familiar, and the familiar, strange.
      Welcome, thrice welcome, to Unix systems programming.
    </p>
    <p class="italic">
      "The Sudonomicon" is a <a href="https://third-bit.com/">Third Bit</a> production.
    </p>
  </div>
</div>

<!-- ---------------------------------------------------------------- -->
<section class="aside">
<h2 class="aside">What This Is</h2>
<ul>
<li>Notes and working examples that instructors can use to perform a lesson<ul>
<li>Do <em>not</em> expect novices with no prior Unix experience to be able to learn from them on their own</li>
</ul>
</li>
<li>Musical analogy<ul>
<li>This is the chord changes and melody</li>
<li>We expect instructors to create an arrangement and/or improvise while delivering</li>
</ul>
</li>
<li>Please see <a href="./license/">the license</a> for terms of use,
    the <a href="./conduct/">Code of Conduct</a> for community standards,
    and <a href="./contributing/">these guidelines</a> for notes on contributing</li>
<li><a href="https://third-bit.com/">Greg Wilson</a> is a programmer, author, and educator based in Toronto</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Scope</h2>
<ul>
<li><a href="http://teachtogether.tech/en/index.html#s:process-personas">Intended audience</a><ul>
<li>Ning did a bachelor&rsquo;s degree in economics
    and now works as a data analyst for the Ministry of Health</li>
<li>They are comfortable working with Unix command-line tools,
    writing data analysis programs in Python,
and downloading data from the web manually</li>
<li>Ning wants to understand what happens when they install a package
or run a pipeline in the cloud</li>
<li>Their work schedule is unpredictable and highly variable,
    so they need to be able to learn a bit at a time</li>
</ul>
</li>
<li>Prerequisites<ul>
<li>Unix shell commands covered in <a href="https://swcarpentry.github.io/shell-novice/">this Software Carpentry lesson</a>:<ul>
<li><code>pwd</code>; <code>ls</code>; <code>cd</code>; <code>.</code> and <code>..</code>; <code>rm</code> and <code>rmdir</code>; <code>mkdir</code>; <code>touch</code>;
    <code>mv</code>; <code>cp</code>; <code>tree</code>; <code>cat</code>; <code>wc</code>; <code>head</code>; <code>tail</code>; <code>less</code>; <code>cut</code>; <code>echo</code>;
    <code>history</code>; <code>find</code>; <code>grep</code>; <code>zip</code>; <code>man</code></li>
<li>current working directory; absolute and relative paths; naming files;
    editing with <code>nano</code></li>
<li>standard input; standard output; standard error; redirection; pipes</li>
<li><code>*</code> and <code>?</code> wildcards; shell variable with <code>$</code> expansion; <code>for</code> loop</li>
</ul>
</li>
<li>Python for command-line scripting<ul>
<li>variables; numbers and strings; lists; dictionaries; <code>for</code> and <code>while</code> loops;
<code>if</code>/<code>else</code>; <code>with</code>; defining and calling functions; <code>sys.argv</code>, <code>sys.stdin</code>,
and <code>sys.stdout</code>; simple regular expressions; reading JSON data;
reading CSV files using <a href="https://pandas.pydata.org/">Pandas</a> or <a href="https://pola.rs/">Polars</a></li>
<li><code>pip install</code></li>
</ul>
</li>
<li><code>python -m venv</code> or <code>conda create</code></li>
</ul>
</li>
<li>Learning outcomes<ol>
<li>Explain the difference between shell variables and environment variables
    and write shell scripts that use each.</li>
<li>Create a virtual environment and explain what this actually does.</li>
<li>Create <code>requirements.txt</code> file for <a href="https://pip.pypa.io/en/stable/"><code>pip</code></a> and explain version pinning.</li>
<li>Explain what a filesystem is (disk partitions, inodes, symbolic links)
    and use <code>df</code>, <code>ln</code>, similar commands to explore with them.</li>
<li>Explain what a process is and use commands like <code>ps</code> and <code>kill</code> to explore and manage them.</li>
<li>Explain what a job is and use commands like <code>jobs</code>, <code>bg</code>, and <code>fg</code> to manage them.</li>
<li>Explain what <code>cron</code> jobs are and how to create them.</li>
<li>Explain the difference between a container and a virtual machine.</li>
<li>Create and manage Docker images.</li>
<li>Explain what ports are and write Python code that uses sockets and HTTP.</li>
<li>Explain what certificates are and how they are used to support HTTPS.</li>
<li>Explain what key pairs are and how they are stored, and create and manage key pairs.</li>
<li>Explain what IP addresses are and how they are resolved.</li>
<li>Explain how traditional password authentication works and describe its weaknesses.</li>
</ol>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Setup</h2>
<ul>
<li>Download <a href="https://github.com/gvwilson/sys-tutorial/raw/main/sys-tutorial.zip">the latest release</a></li>
<li>Unzip the file in a temporary directory to create:<ul>
<li><code>./site/*.*</code>: files and directories used in examples</li>
<li><code>./src/*.*</code>: shell scripts and Python programs</li>
<li><code>./out/*.*</code>: expected output for examples</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">1: Operating System vs. Shell</h2>
<ul>
<li>OS is…</li>
<li>Shell is…</li>
<li>Many different shells</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">2: Program vs. Process</h2>
<ul>
<li>A program is…</li>
<li>A <a href="#g:process">process</a> is a running instance of a program<ul>
<li>Code plus variables in memory plus open files plus some IDs</li>
</ul>
</li>
<li>Tools to manage them were invented when most users only had a single terminal</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">3: Viewing Processes</h2>
<ul>
<li>Use <code>ps -a -l</code> to see currently running processes in terminal<ul>
<li><code>UID</code>: numeric ID of the user that the process belongs to</li>
<li><code>PID</code>: process&rsquo;s unique ID</li>
<li><code>PPID</code>: ID of the process&rsquo;s parent (i.e., the process that created it)</li>
<li><code>CMD</code>: the command the process is running</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/ps_a_l.sh">src/ps_a_l.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>ps<span class="w"> </span>-a<span class="w"> </span>-l
</code></pre></div>
</div>
<p class="inclusion"><a href="out/ps_a_l.out">out/ps_a_l.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>UID   PID  PPID        F CPU PRI NI        SZ    RSS       TTY       TIME CMD
    0 13215 83470     4106   0  31  0 408655632   9504   ttys001    0:00.02 login -pfl gvwilson /
  501 13216 13215     4006   0  31  0 408795632   5424   ttys001    0:00.04 -bash
  501 13569 13216     4046   0  31  0 408895008  20864   ttys001    0:00.10 python -m http.server
    0 13577 13216     4106   0  31  0 408766128   1888   ttys001    0:00.01 ps -a -l
</code></pre></div>
</div>
<ul>
<li>Use <code>ps -a -x</code> to see (almost) all processes running on computer<ul>
<li><code>ps -a -x | wc</code> tells me there are 655 processes running on my laptop right now</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 1</strong>:
What does the <code>top</code> command do?
What does <code>top -o cpu</code> do?</p>
<p><strong>Exercise 2</strong>:
What does the <code>pgrep</code> command do?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">4: Parent and Child Processes</h2>
<ul>
<li>Every process is created by another process<ul>
<li>Except the first</li>
</ul>
</li>
<li>Refer to <a href="#g:child_process">child process</a> and <a href="#g:parent_process">parent process</a></li>
<li><code>echo $$</code> shows <a href="#g:process_id">process ID</a> of current process<ul>
<li><code>$$</code> shortcut because it&rsquo;s used so often</li>
</ul>
</li>
<li><code>echo $PPID</code> (parent process ID) to get parent</li>
<li><code>pstree $$</code> to see <a href="#g:process_tree">process tree</a></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">5: Signals</h2>
<ul>
<li>Can send a <a href="#g:signal">signal</a> to a process<ul>
<li>Something extraordinary happened, please deal with it immediately</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: right;">Number</th>
<th>Name</th>
<th>Default Action</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">1</td>
<td><code>SIGHUP</code></td>
<td>terminate process</td>
<td>terminal line hangup</td>
</tr>
<tr>
<td style="text-align: right;">2</td>
<td><code>SIGINT</code></td>
<td>terminate process</td>
<td>interrupt program</td>
</tr>
<tr>
<td style="text-align: right;">3</td>
<td><code>SIGQUIT</code></td>
<td>create core image</td>
<td>quit program</td>
</tr>
<tr>
<td style="text-align: right;">4</td>
<td><code>SIGILL</code></td>
<td>create core image</td>
<td>illegal instruction</td>
</tr>
<tr>
<td style="text-align: right;">8</td>
<td><code>SIGFPE</code></td>
<td>create core image</td>
<td>floating-point exception</td>
</tr>
<tr>
<td style="text-align: right;">9</td>
<td><code>SIGKILL</code></td>
<td>terminate process</td>
<td>kill program</td>
</tr>
<tr>
<td style="text-align: right;">11</td>
<td><code>SIGSEGV</code></td>
<td>create core image</td>
<td>segmentation violation</td>
</tr>
<tr>
<td style="text-align: right;">12</td>
<td><code>SIGSYS</code></td>
<td>create core image</td>
<td>non-existent system call invoked</td>
</tr>
<tr>
<td style="text-align: right;">14</td>
<td><code>SIGALRM</code></td>
<td>terminate process</td>
<td>real-time timer expired</td>
</tr>
<tr>
<td style="text-align: right;">15</td>
<td><code>SIGTERM</code></td>
<td>terminate process</td>
<td>software termination signal</td>
</tr>
<tr>
<td style="text-align: right;">17</td>
<td><code>SIGSTOP</code></td>
<td>stop process</td>
<td>stop (cannot be caught or ignored)</td>
</tr>
<tr>
<td style="text-align: right;">24</td>
<td><code>SIGXCPU</code></td>
<td>terminate process</td>
<td>CPU time limit exceeded</td>
</tr>
<tr>
<td style="text-align: right;">25</td>
<td><code>SIGXFSZ</code></td>
<td>terminate process</td>
<td>file size limit exceeded</td>
</tr>
</tbody>
</table>
<ul>
<li>Create a <a href="#g:callback_function">callback function</a> to act as a <a href="#g:signal_handler">signal handler</a></li>
</ul>
<p class="inclusion"><a href="src/catch_interrupt.py">src/catch_interrupt.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">COUNT</span>
    <span class="n">COUNT</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;interrupt </span><span class="si">{</span><span class="n">COUNT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">COUNT</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;use Ctrl-C three times&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/catch_interrupt.out">out/catch_interrupt.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>python src/catch_interrupt.py
use Ctrl-C three times
^Cinterrupt 1
^Cinterrupt 2
^Cinterrupt 3
</code></pre></div>
</div>
<ul>
<li><code>^C</code> shows where user typed Ctrl-C</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">6: Background Processes</h2>
<ul>
<li>Can run a process in the <a href="#g:background_process">background</a><ul>
<li>Only difference is that it&rsquo;s not connected to the terminal</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/show_timer.py">src/show_timer.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loop </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loop finished&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/show_timer.sh">src/show_timer.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/show_timer.py<span class="w"> </span><span class="p">&amp;</span>
ls<span class="w"> </span>site
</code></pre></div>
</div>
<p class="inclusion"><a href="out/show_timer.out">out/show_timer.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>$ src/show_timer.sh
birds.csv       cert_authority.srl  sandbox         server.pem      species.csv
cert_authority.key  motto.json      server.csr      server_first_cert.pem   yukon.db
cert_authority.pem  motto.txt       server.key      server_first_key.pem
loop 0
$ loop 1
loop 2
loop finished
</code></pre></div>
</div>
<ul>
<li><code>&amp;</code> at end of command to run <code>show_timer.py</code> means &ldquo;run in the background&rdquo;</li>
<li>So <code>ls</code> command executes immediately</li>
<li>But <code>show_timer.py</code> keeps running until it finishes<ul>
<li>Or needs keyboard input</li>
</ul>
</li>
<li>Can also start process and then <a href="#g:suspend_process">suspend</a> it with Ctrl-Z<ul>
<li>Sends <code>SIGSTOP</code> instead of <code>SIGINT</code></li>
</ul>
</li>
<li>Use <code>jobs</code> to see all suspended processes</li>
<li>Then <code>bg %<em>num</em></code> to resume in the background</li>
<li>Or <code>fg %<em>num</em></code> to <a href="#g:foreground_process">foreground</a> the process
    to <a href="#g:resume_process">resume</a> its execution</li>
</ul>
<p class="inclusion"><a href="src/ctrl_z_background.text">src/ctrl_z_background.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ python src/show_timer.py
loop 0
^Z
[1]+  Stopped                 python src/show_timer.py
$ jobs
[1]+  Stopped                 python src/show_timer.py
$ bg
[1]+ python src/show_timer.py &amp;
loop 1
$ loop 2
loop finished
[1]+  Done                    python src/show_timer.py
</code></pre></div>
</div>
<ul>
<li>Note that input and output are mixed together</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">7: Killing Processes</h2>
<ul>
<li>Use <code>kill</code> to send a signal to a process<ul>
<li>Not necessarily to stop it</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/kill_process.text">src/kill_process.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ python src/show_timer.py
loop 0
^Z
[1]+  Stopped                 python src/show_timer.py
$ kill %1
[1]+  Terminated: 15          python src/show_timer.py
</code></pre></div>
</div>
<ul>
<li>By default, <code>kill</code> sends <code>SIGTERM</code> (terminate process)</li>
<li>Variations:<ul>
<li>Give a process ID: <code>kill 1234</code></li>
<li>Send a different signal: <code>kill -s INT %1</code></li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/kill_int.text">src/kill_int.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ python src/show_timer.py
loop 0
^Z
[1]+  Stopped                 python src/show_timer.py
$ kill -s INT %1
[1]+  Stopped                 python src/show_timer.py
$ fg
python src/show_timer.py
Traceback (most recent call last):
  File &quot;/tut/sys/src/show_timer.py&quot;, line 5, in &lt;module&gt;
    time.sleep(1)
KeyboardInterrupt
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">8: Fork</h2>
<ul>
<li><a href="#g:fork_process">Fork</a> creates a duplicate of a process<ul>
<li>Creator is parent, gets process ID of child as return value</li>
<li>Child gets 0 as return value (but has something else as its process ID)</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/fork.py">src/fork.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;child got </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parent got </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/fork.out">out/fork.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>starting 41618
parent got 41619 is 41618
child got 0 is 41619
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">9: Flushing I/O</h2>
<ul>
<li>Example above works interactively</li>
<li>Run as <code>python fork.py &gt; temp.out</code>, the &ldquo;starting&rdquo; line is duplicated</li>
<li><p class="center"><span class="todo">TODO: explain I/O flushing</span></p></li>
</ul>
<p class="inclusion"><a href="src/flush.py">src/flush.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;child got </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parent got </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">10: Exec</h2>
<ul>
<li>The <code>exec</code> family of functions in <code>os</code> execute a new program <em>inside the calling process</em><ul>
<li>Replace existing program and start a new one</li>
</ul>
</li>
<li>So <code>fork</code>/<code>exec</code> to run a program</li>
</ul>
<p class="inclusion"><a href="src/fork_exec.py">src/fork_exec.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">execl</span><span class="p">(</span><span class="s2">&quot;/bin/echo&quot;</span><span class="p">,</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;child echoing </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parent got </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/fork_exec.out">out/fork_exec.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>starting 46713
parent got 46714 is 46713
child echoing 0 from 46714
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 3</strong>:
What are the differences between <code>os.execl</code>, <code>os.execlp</code>, and <code>os.execv</code>?
When and why would you use each?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">11: Shell Variables</h2>
<ul>
<li>The shell is a program and programs have variables</li>
<li>Create or change with <code><em>name</em>=<em>value</em></code></li>
<li><a href="#g:shell_var">Shell variable</a> stays in the process</li>
<li>Use <code>$<em>name</em></code> to get value<ul>
<li>Because people type file and directory names more often</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/shell_var_outer.sh">src/shell_var_outer.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="c1"># shell_var_outer.sh</span>
<span class="nv">WINDOW</span><span class="o">=</span><span class="s2">&quot;neighbor&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;outer: window is </span><span class="si">${</span><span class="nv">WINDOW</span><span class="si">}</span><span class="s2">&quot;</span>
bash<span class="w"> </span>src/shell_var_inner.sh
</code></pre></div>
</div>
<p class="inclusion"><a href="src/shell_var_inner.sh">src/shell_var_inner.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="c1"># shell_var_inner.sh</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;inner: window is </span><span class="si">${</span><span class="nv">window</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/shell_var_outer.out">out/shell_var_outer.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>outer: window is neighbor
inner: window is
</code></pre></div>
</div>
<ul>
<li>Note: variables usually written in upper case to distinguish them from filenames<ul>
<li>So underscores as separators</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 4</strong>:
What happens if you modify the scripts shown above
to use single quotes instead of double quotes?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">12: Environment Variables</h2>
<ul>
<li><a href="#g:env_var">Environment variable</a> is inherited by new processes</li>
<li>Use <code>export <em>name</em>=<em>value</em></code></li>
</ul>
<p class="inclusion"><a href="src/env_var_outer.sh">src/env_var_outer.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="c1"># env_var_outer.sh</span>
<span class="nv">WINDOW</span><span class="o">=</span><span class="s2">&quot;neighbor&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">THRESHOLD</span><span class="o">=</span><span class="m">0</span>.5
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;outer: window is </span><span class="si">${</span><span class="nv">WINDOW</span><span class="si">}</span><span class="s2"> and threshold is </span><span class="si">${</span><span class="nv">THRESHOLD</span><span class="si">}</span><span class="s2">&quot;</span>
bash<span class="w"> </span>src/env_var_inner.sh
</code></pre></div>
</div>
<p class="inclusion"><a href="src/env_var_inner.sh">src/env_var_inner.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="c1"># env_var_inner.sh</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;inner: window is </span><span class="si">${</span><span class="nv">window</span><span class="si">}</span><span class="s2"> and threshold is </span><span class="si">${</span><span class="nv">threshold</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/env_var_outer.out">out/env_var_outer.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>outer: window is neighbor and threshold is 0.5
inner: window is  and threshold is
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 5</strong>:
If a child process sets shell or environment variables,
are they visible in the parent once the child finishes executing?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">13: Environment Variables in Programs</h2>
<ul>
<li>Environment variables are inherited by child process…</li>
<li>…so they are inherited by programs (not just shell scripts)</li>
</ul>
<p class="inclusion"><a href="src/env_var_py.sh">src/env_var_py.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="c1"># env_var_py.sh</span>
<span class="nv">WINDOW</span><span class="o">=</span><span class="s2">&quot;neighbor&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">THRESHOLD</span><span class="o">=</span><span class="m">0</span>.5
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;outer: window is </span><span class="si">${</span><span class="nv">WINDOW</span><span class="si">}</span><span class="s2"> and threshold is </span><span class="si">${</span><span class="nv">THRESHOLD</span><span class="si">}</span><span class="s2">&quot;</span>
python<span class="w"> </span>src/env_var_py.py
</code></pre></div>
</div>
<p class="inclusion"><a href="src/env_var_py.py">src/env_var_py.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="c1"># env_var_py.py</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">window</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WINDOW&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;not set&quot;</span><span class="p">)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;THRESHOLD&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;not set&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inner: window is </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2"> and threshold is </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/env_var_py.out">out/env_var_py.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>outer: window is neighbor and threshold is 0.5
inner: window is not set and threshold is 0.5
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">14: Inspecting Variables</h2>
<ul>
<li><code>set</code> on its own lists variables, functions, etc.</li>
<li><code>env</code> shows all environment variables</li>
</ul>
<p class="inclusion"><a href="src/show_env_vars.sh">src/show_env_vars.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>env<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="o">=</span><span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">10</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/show_env_vars.out">out/show_env_vars.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>BASH_SILENCE_DEPRECATION_WARNING
CONDA_DEFAULT_ENV
CONDA_EXE
CONDA_PREFIX
CONDA_PREFIX_1
CONDA_PROMPT_MODIFIER
CONDA_PYTHON_EXE
CONDA_SHLVL
EDITOR
GEM_HOME
</code></pre></div>
</div>
<ul>
<li>Many tools create variables to manage configuration<ul>
<li>No guarantees that they don&rsquo;t collide with each other</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 6</strong>:
The <code>os.environ</code> variable in Python&rsquo;s <code>os</code> module
is an easy way to get all of the process&rsquo;s environment variables.
Compare it to what <code>env</code> shows.
Are there differences?
If so, what are they and why do they exist?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">15: Important Environment Variables</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>Typical Value</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EDITOR</code></td>
<td><code>nano</code></td>
<td>default text editor</td>
</tr>
<tr>
<td><code>HOME</code></td>
<td><code>/Users/tut</code></td>
<td>user&rsquo;s home directory</td>
</tr>
<tr>
<td><code>LANG</code></td>
<td><code>en_CA.UTF-8</code></td>
<td>user&rsquo;s preferred (human) language</td>
</tr>
<tr>
<td><code>PATH</code></td>
<td>see below</td>
<td>search path for programs</td>
</tr>
<tr>
<td><code>PWD</code></td>
<td><code>/Users/tut/sys</code></td>
<td>present working directory</td>
</tr>
<tr>
<td><code>SHELL</code></td>
<td><code>/bin/bash</code></td>
<td>user&rsquo;s default shell</td>
</tr>
<tr>
<td><code>TERM</code></td>
<td><code>xterm-256color</code></td>
<td>type of terminal</td>
</tr>
<tr>
<td><code>TMPDIR</code></td>
<td><code>/var/tmp</code></td>
<td>storage for temporary files</td>
</tr>
<tr>
<td><code>USER</code></td>
<td><code>tut</code></td>
<td>current user&rsquo;s name</td>
</tr>
</tbody>
</table>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">16: Search Path</h2>
<ul>
<li><code>PATH</code> holds a colon-separated list of directories</li>
<li>Shell looks in these <em>in order</em> to find commands</li>
<li>Looking at them all on one line is annoying, so use <code>tr</code> to split</li>
</ul>
<p class="inclusion"><a href="src/show_path.sh">src/show_path.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">&#39;\n&#39;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/show_path.out">out/show_path.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>/Users/tut/google-cloud-sdk/bin
/Users/tut/conda/envs/sys/bin
/Users/tut/conda/condabin
/Users/tut/.nvm/versions/node/v20.8.0/bin
/Users/tut/bin
/Applications/Postgres.app/Contents/Versions/14/bin
/Users/tut/go/bin
/usr/local/bin
/System/Cryptexes/App/usr/bin
/usr/bin
/bin
/usr/sbin
/sbin
/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin
/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin
/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin
/Library/Apple/usr/bin
/Library/TeX/texbin
/usr/local/bin
</code></pre></div>
</div>
<ul>
<li>Notice <code>/Users/tut/bin</code></li>
<li>Common to have a <code>~/bin</code> directory with the user&rsquo;s own utilities</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">17: Adding to the Search Path</h2>
<ul>
<li>Shell variables (of both kinds) are just strings</li>
<li>So redefine the variable to the old value with a new directory at the front</li>
</ul>
<p class="inclusion"><a href="src/change_path.sh">src/change_path.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/tmp/bin:</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/change_path.out">out/change_path.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>/tmp/bin
/Users/gregwilson/google-cloud-sdk/bin
/Users/gregwilson/conda/envs/sys/bin
/Users/gregwilson/conda/condabin
/Users/gregwilson/.gem/ruby/3.1.2/bin
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">18: Startup Files</h2>
<ul>
<li>Bash shell runs commands in <code>~/.bash_profile</code> for login shells</li>
<li>Bash shell runs commands in <code>~/.bashrc</code> for interactive shells</li>
<li>Yes, the terminology is confusing</li>
<li>Common to have <code>~/.bash_profile</code> <a href="#g:source_shell">source</a> <code>~/.bashrc</code><ul>
<li>I.e., run those commands in the current shell</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/source_bashrc.sh">src/source_bashrc.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="nb">source</span><span class="w"> </span><span class="nv">$HOME</span>/.bashrc
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Command Interpolation</h2>
<ul>
<li>Can use <code>outer $(<em>inner</em>)</code> to run <code>inner</code> and use its output as arguments to <code>outer</code></li>
<li>Long-winded way to count lines in some text files</li>
</ul>
<p class="inclusion"><a href="src/interpolate.sh">src/interpolate.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>wc<span class="w"> </span>-l<span class="w"> </span><span class="k">$(</span>ls<span class="w"> </span>src/*.text<span class="k">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/interpolate.out">out/interpolate.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>12 src/ctrl_z_background.text
      12 src/kill_int.text
       6 src/kill_process.text
      30 total
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 7</strong>:
Removing a directory from <code>PATH</code> is harder than adding one.
Write a shell script that:</p>
<ol>
<li>Splits <code>PATH</code> on colons to put one entry on each line.</li>
<li>Uses <code>grep</code> to remove the undesired line.</li>
<li>Uses <code>paste -s -d :</code> to recombine the lines.</li>
<li>Uses command interpolation to assign the result back to <code>PATH</code>.</li>
</ol>
<p>This exercise may remind you why complicated operations should be done in Python
rather than in the shell.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">19: Virtual Environments</h2>
<ul>
<li>If two directories <code>A</code> and <code>B</code> contain a program <code>xyz</code> and <code>A</code> comes before <code>B</code>,
    <code>xyz</code> on its own will run <code>A/xyz</code> instead of <code>B/xyz</code></li>
<li>This is how <a href="#g:virtual_env">virtual environments</a> work</li>
</ul>
<p class="inclusion"><a href="src/show_virtual_env.sh">src/show_virtual_env.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>conda
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;python is&quot;</span><span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>python<span class="k">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/show_virtual_env.out">out/show_virtual_env.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>/Users/tut/conda/envs/sys/bin
/Users/tut/conda/condabin
python is /Users/tut/conda/envs/sys/bin/python
</code></pre></div>
</div>
<ul>
<li>Virtual environment is initially a minimal Python installation</li>
<li>Installing new packages puts them in the environment&rsquo;s directory</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">20: Package Installation</h2>
<ol>
<li>Create a new virtual environment called <code>example</code>: <code>conda create -n example python=3.12</code></li>
<li>Activate that virtual environment: <code>conda activate example</code></li>
<li>Install the <code>faker</code> package: <code>pip install faker</code></li>
</ol>
<p class="inclusion"><a href="src/find_faker.sh">src/find_faker.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>find<span class="w"> </span><span class="nv">$HOME</span>/conda/envs/example<span class="w"> </span>-name<span class="w"> </span>faker
</code></pre></div>
</div>
<p class="inclusion"><a href="out/find_faker.out">out/find_faker.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>/Users/tut/conda/envs/example/bin/faker
/Users/tut/conda/envs/example/lib/python3.12/site-packages/faker
</code></pre></div>
</div>
<ul>
<li>The script in <code>bin</code> loads the module and runs it</li>
</ul>
<p class="inclusion"><a href="src/faker_bin.py">src/faker_bin.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="ch">#!/Users/gregwilson/conda/envs/example/bin/python3.12</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">faker.cli</span> <span class="kn">import</span> <span class="n">execute_from_command_line</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(-script\.pyw|\.exe)?$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">execute_from_command_line</span><span class="p">())</span>
</code></pre></div>
</div>
<ul>
<li>The directory under <code>site-packages</code> has 642 Python files (as of version 24.3.0)</li>
<li>The <code>python</code> in the virtual environment&rsquo; <code>bin</code> directory
    knows to look in that environment&rsquo;s <code>site-packages</code> directory</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 8</strong>:
What is the <code>re.sub</code> call in the <code>faker</code> script doing and why?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Limits of Virtual Environments</h2>
<ul>
<li><code>conda</code> and <code>python -m venv</code> work for Python</li>
<li>But what about Rust, JavaScript, and other languages?</li>
<li>In particular, what if you need an isolated environment for several languages at once?</li>
<li>And you want other people to be able to reproduce it?</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">21: Changing the Root Directory</h2>
<ul>
<li>The <code>chroot</code> command<ul>
<li>Changes the process&rsquo;s idea of the <a href="#g:root_directory">root directory</a></li>
<li>Runs a command</li>
</ul>
</li>
<li>But…</li>
</ul>
<p class="inclusion"><a href="src/chroot_example.sh">src/chroot_example.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/filesystem
chroot<span class="w"> </span>/tmp/filesystem<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;it worked&quot;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/chroot_example.out">out/chroot_example.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>chroot: /tmp/filesystem: Operation not permitted
</code></pre></div>
</div>
<ul>
<li>Need special permission (discussed below)</li>
<li>Everything needed to run <code>echo</code> and other commands needs to be in the new filesystem</li>
<li>Only isolates the filesystem</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">22: sudo</h2>
<ul>
<li>Every machine has a <a href="#g:superuser">superuser</a> account called <a href="#g:root_user">root</a><ul>
<li>Which has nothing to do with the root directory of the filesystem</li>
</ul>
</li>
<li>Use <code>sudo</code> (&ldquo;superuser do&rdquo;) to change identity temporarily</li>
</ul>
<p class="inclusion"><a href="src/sudo_example.sh">src/sudo_example.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/filesystem
sudo<span class="w"> </span>chroot<span class="w"> </span>/tmp/filesystem<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;it worked&quot;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/sudo_example.out">out/sudo_example.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Password: ************
chroot: echo: No such file or directory
</code></pre></div>
</div>
<ul>
<li>At least it&rsquo;s a different error message…</li>
<li><code>sudo</code> is a way to give yourself permission to mess up everything on your computer</li>
<li>So another requirement for virtual environments:
    break them without breaking anything else</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">23: Docker</h2>
<ul>
<li><a href="https://www.docker.com/">Docker</a> solves all of these problems</li>
<li>Define an <a href="#g:docker_image">image</a> with its own copy of the operating system, filesystem, etc.</li>
<li>Run it in a <a href="#g:docker_container">container</a> that is isolated from the rest of your computer</li>
</ul>
<p class="inclusion"><a href="src/docker_image_ls.sh">src/docker_image_ls.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>image<span class="w"> </span>ls
</code></pre></div>
</div>
<p class="inclusion"><a href="out/docker_image_ls.out">out/docker_image_ls.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>REPOSITORY   TAG       IMAGE ID   CREATED   SIZE
</code></pre></div>
</div>
<p class="inclusion"><a href="src/docker_container_ls.sh">src/docker_container_ls.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>container<span class="w"> </span>ls
</code></pre></div>
</div>
<p class="inclusion"><a href="out/docker_container_ls.out">out/docker_container_ls.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Common Error Message</h2>
<ul>
<li>Docker requires a <a href="#g:daemon">daemon</a> process to be running in the background to start images</li>
</ul>
<p class="inclusion"><a href="src/docker_image_ls.sh">src/docker_image_ls.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>image<span class="w"> </span>ls
</code></pre></div>
</div>
<p class="inclusion"><a href="out/docker_image_ls_err.out">out/docker_image_ls_err.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Cannot connect to the Docker daemon at unix:///Users/tut/.docker/run/docker.sock.
Is the docker daemon running?
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">24: Running a Container</h2>
<p class="inclusion"><a href="src/docker_run_fresh.text">src/docker_run_fresh.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu:latest
Unable to find image &#39;ubuntu:latest&#39; locally
latest: Pulling from library/ubuntu
bccd10f490ab: Pull complete 
Digest: sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e
Status: Downloaded newer image for ubuntu:latest

$ docker container ls

$ docker container ls -a
CONTAINER ID   IMAGE           COMMAND       CREATED          STATUS                     PORTS     NAMES
741bb295734f   ubuntu:latest   &quot;/bin/bash&quot;   10 seconds ago   Exited (0) 9 seconds ago             xenodochial_mclaren

$ docker image ls
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
ubuntu       latest    ca2b0f26964c   3 weeks ago   77.9MB
</code></pre></div>
</div>
<ul>
<li>Ask Docker to run a container with <code>ubuntu:latest</code><ul>
<li>I.e., latest stable version of Ubuntu Linux from <a href="https://hub.docker.com/">Docker Hub</a></li>
</ul>
</li>
<li>Docker can&rsquo;t find a <a href="#g:cache">cached</a> copy locally, so it downloads the image</li>
<li>Then runs it</li>
<li>But its default command is <code>/bin/bash</code> with no inputs, so it exits immediately.</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">25: Re-running a Container</h2>
<p class="inclusion"><a href="src/docker_run_again.text">src/docker_run_again.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu:latest pwd
/

$ docker container run ubuntu:latest ls
bin
boot
dev
etc
home
…more entries…
sys
tmp
usr
var
</code></pre></div>
</div>
<ul>
<li>Doesn&rsquo;t need to download again</li>
<li>Runs the given command instead of the default <code>/bin/bash</code></li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">This Doesn&rsquo;t Work</h2>
<p class="inclusion"><a href="src/docker_run_error.text">src/docker_run_error.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu:latest &quot;echo hello&quot;
docker: Error response from daemon: \
failed to create task for container: \
failed to create shim task: \
OCI runtime create failed: \
runc create failed: \
unable to start container process: \
exec: &quot;echo hello&quot;: executable file not found in $PATH: unknown.
</code></pre></div>
</div>
<ul>
<li>Thinks that <code>"echo hello"</code> is the name of the command to run</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">26: Inside the Container</h2>
<p class="inclusion"><a href="src/docker_run_interactive.text">src/docker_run_interactive.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container run -i -t ubuntu:latest
root@4238b3b51abd:/# pwd
/
root@4238b3b51abd:/# whoami
root
root@4238b3b51abd:/# ls
bin  boot  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
root@4238b3b51abd:/# ^D
exit
$
</code></pre></div>
</div>
<ul>
<li><code>-i</code>: interactive</li>
<li><code>-t</code>: terminal (kind of)<ul>
<li>Combination often abbreviated <code>-it</code></li>
</ul>
</li>
<li>The hexadecimal number after <code>root@</code> is the container&rsquo;s unique ID</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">27: Persistence</h2>
<p class="inclusion"><a href="src/docker_run_nonpersistent.text">src/docker_run_nonpersistent.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container run -i -t ubuntu:latest
root@a8ea570a84d3:/# ls /tmp
root@a8ea570a84d3:/# touch /tmp/proof-we-were-here.txt
root@a8ea570a84d3:/# ls /tmp
proof-we-were-here.txt
root@a8ea570a84d3:/# ^D
exit

$ docker container run -i -t ubuntu:latest
root@f792c15ebb5b:/# ls /tmp
root@f792c15ebb5b:/# ^D
exit
</code></pre></div>
</div>
<ul>
<li>Container starts fresh each time it runs</li>
<li>Notice that the container&rsquo;s ID changes each time it runs</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">28: What Is Running</h2>
<p class="inclusion"><a href="src/docker_container_ls_id.text">src/docker_container_ls_id.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container ls --format &quot;table {{.ID}}\t{{.Status}}&quot; |
CONTAINER ID   STATUS                                       |
                                                            |
                                                            | $ docker container run -it ubuntu:latest
                                                            | root@a5427ccdeb26:/#
                                                            |
$ docker container ls --format &quot;table {{.ID}}\t{{.Status}}&quot; |
CONTAINER ID   STATUS                                       |
a5427ccdeb26   Up 38 seconds                                |
                                                            |
                                                            | root@a5427ccdeb26:/# ^D
                                                            | exit
                                                            |
$ docker container ls --format &quot;table {{.ID}}\t{{.Status}}&quot; |
CONTAINER ID   STATUS                                       |
</code></pre></div>
</div>
<ul>
<li><code>docker container ls</code> on its own shows a wide table</li>
<li>Use <a href="https://go.dev/">Go</a> format strings to format output (no, really)</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">29: Installing Software</h2>
<p class="inclusion"><a href="src/docker_install_python.text">src/docker_install_python.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code># apt update
…lots of output…

# apt install python3
…lots of output…

# which python

# which python3
/usr/bin/python3

# python3 --version
Python 3.10.12
</code></pre></div>
</div>
<ul>
<li><code>apt update</code> to update available package lists</li>
<li><code>apt install</code> to install the desired package<ul>
<li>Installs lots of dependencies as well</li>
</ul>
</li>
<li>Doesn&rsquo;t create <code>python</code> (note lack of output)</li>
<li>Creates <code>python3</code> instead</li>
<li>Version is most recent in the default repository</li>
<li>But <em>it isn&rsquo;t there the next time we run</em></li>
</ul>
<p class="inclusion"><a href="src/docker_install_python_nonpersistent.text">src/docker_install_python_nonpersistent.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code># ^D
exit

$ docker run -it ubuntu:latest

# which python

# ^D
exit
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">30: Actually Installing Software</h2>
<ul>
<li>Create a Dockerfile<ul>
<li>Usually called that and in a directory of its own</li>
<li>Ours is <code>src/ubuntu-python/Dockerfile</code></li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/ubuntu-python3/Dockerfile">src/ubuntu-python3/Dockerfile</a></p>
<div class="language-">
<div class="highlight"><pre><span></span><code>FROM ubuntu:latest

RUN apt update
RUN apt install python3 -y
</code></pre></div>
</div>
<ul>
<li>Tell docker to build the image</li>
</ul>
<p class="inclusion"><a href="src/ubuntu-python3-build.text">src/ubuntu-python3-build.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>#0 building with &quot;desktop-linux&quot; instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 99B done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/ubuntu:latest
#2 DONE 1.6s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [1/3] FROM docker.io/library/ubuntu:latest@sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e
#4 resolve docker.io/library/ubuntu:latest@sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e done
#4 DONE 0.0s

#5 [2/3] RUN apt update
#5 CACHED

#6 [3/3] RUN apt install python3 -y
#6 CACHED

#7 exporting to image
#7 exporting layers done
#7 writing image sha256:c06d47d8275d4ef724dad192bf72daaac6b86701a1be40e1ac03f53092201d71 done
#7 naming to docker.io/gvwilson/ubuntu-python3 done
#7 DONE 0.0s
</code></pre></div>
</div>
<ul>
<li><code>CACHED</code> because we&rsquo;ve run this several times while building this tutorial</li>
</ul>
<p class="inclusion"><a href="src/ubuntu-python3-run.text">src/ubuntu-python3-run.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>$ docker container run -it gvwilson/ubuntu-python3
# which python3
/usr/bin/python3
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Stitch These Together</h2>
<blockquote>
<p>What follows is legacy material from an earlier attempt to write this tutorial.
Once there is more Docker above,
something will be added here to stitch the two parts together.</p>
</blockquote>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Start with Something Simple</h2>
<p class="inclusion"><a href="src/get_remote.py">src/get_remote.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://gvwilson.github.io/safety-tutorial/site/motto.txt&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;body:</span><span class="se">\n</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_remote.out">out/get_remote.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>status code: 200
body:
Start where you are, use what you have, help who you can.
</code></pre></div>
</div>
<ul>
<li>Use the <a href="https://requests.readthedocs.io/en/latest/"><code>requests</code></a> module to send an <a href="#g:http">HTTP</a> <a href="#g:http_request">request</a></li>
<li>The URL identifies the file we want<ul>
<li>Though as we&rsquo;ll see, the server can interpret it differently</li>
</ul>
</li>
<li>Response includes:<ul>
<li><a href="#g:http_status_code">HTTP status code</a> such as 200 (OK) or 404 (Not Found)</li>
<li>The text of the response</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">What Just Happened</h2>
<figure id="figure_1">
<img src="img/http_lifecycle.svg" alt="HTTP request/response lifecycle"/>
<figcaption>Figure 1: Lifecycle of an HTTP request and response</figcaption>
</figure>
<ul>
<li>Open a connection to the server</li>
<li>Send an <a href="#g:http_request">HTTP request</a> for the file we want</li>
<li>Server creates a <a href="#g:http_response">response</a> that includes the contents of the file</li>
<li>Sends it back</li>
<li><code>requests</code> parses the response and creates a Python object for us</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">31: Request Structure</h2>
<p class="inclusion"><a href="src/dump_structure.py">src/dump_structure.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests_toolbelt.utils</span> <span class="kn">import</span> <span class="n">dump</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://gvwilson.github.io/safety-tutorial/site/motto.txt&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dump</span><span class="o">.</span><span class="n">dump_all</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/dump_structure.out">out/dump_structure.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>GET /safety-tutorial/site/motto.txt HTTP/1.1
Host: gvwilson.github.io
User-Agent: python-requests/2.31.0
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
</code></pre></div>
</div>
<ul>
<li>First line is <a href="#g:http_method">method</a>, URL, and protocol version</li>
<li>Every HTTP request can have <a href="#g:http_header">headers</a> with extra information</li>
<li>And optionally data being uploaded (which we will see later)</li>
<li>Yes, it&rsquo;s all just text</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">32: Response Structure</h2>
<p class="inclusion"><a href="src/response_headers.py">src/response_headers.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://gvwilson.github.io/web-tutorial/site/motto.txt&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/response_headers.out">out/response_headers.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>Connection: keep-alive
Content-Length: 5142
Server: GitHub.com
Content-Type: text/html; charset=utf-8
permissions-policy: interest-cohort=()
ETag: W/&quot;65c56fc7-239b&quot;
Content-Security-Policy: default-src &#39;none&#39;; style-src &#39;unsafe-inline&#39;; img-src data:; connect-src &#39;self&#39;
Content-Encoding: gzip
X-GitHub-Request-Id: A08C:5A357:7CF794:9CEA06:65D13923
Accept-Ranges: bytes
Date: Sat, 17 Feb 2024 22:54:27 GMT
Via: 1.1 varnish
Age: 0
X-Served-By: cache-yyz4563-YYZ
X-Cache: MISS
X-Cache-Hits: 0
X-Timer: S1708210467.301651,VS0,VE20
Vary: Accept-Encoding
X-Fastly-Request-ID: cb16df2dfa73aaf6de87924c743dd1e50a0ce570
</code></pre></div>
</div>
<ul>
<li>Every HTTP response also has with extra information<ul>
<li>Does <em>not</em> include status code: that appears in the first line</li>
</ul>
</li>
<li>Most important for now are:<ul>
<li><code>Content-Length</code>: number of bytes in response data (i.e., how much to read)</li>
<li><code>Content-Type</code>: <a href="#g:mime_type">MIME type</a> of data (e.g., <code>text/plain</code>)</li>
</ul>
</li>
<li>From now on we will only show interesting headers</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 9</strong>:
Add header called <code>Studying</code> with the value <code>safety</code> to the <code>requests</code> script shown above.
Does it make a difference to the response?
Should it?</p>
<p><strong>Exercise 10</strong>:
What is the difference between the <code>Content-Type</code> and the <code>Content-Encoding</code> headers?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">33: When Things Go Wrong</h2>
<p class="inclusion"><a href="src/get_404.py">src/get_404.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://gvwilson.github.io/web-tutorial/site/nonexistent.txt&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;body length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_404.out">out/get_404.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>status code: 404
body length: 9115
</code></pre></div>
</div>
<ul>
<li>The 404 status code tells us something went wrong</li>
<li>The 9 kilobyte response is an HTML page with an embedded image (the GitHub logo)</li>
<li>The page contains human-readable error messages<ul>
<li>But we have to know page format to pull them out</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 11</strong>:
Look at <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">this list of HTTP status codes</a>.</p>
<ol>
<li>
<p>What is the difference between status code 403 and status code 404?</p>
</li>
<li>
<p>What is status code 418 used for?</p>
</li>
<li>
<p>Under what circumstances would you expect to get a response whose status code is 505?</p>
</li>
</ol>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">34: Getting JSON</h2>
<p class="inclusion"><a href="src/get_json.py">src/get_json.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://gvwilson.github.io/web-tutorial/site/motto.json&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;body as text: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
<span class="n">as_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;body as JSON:</span><span class="se">\n</span><span class="si">{</span><span class="n">as_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_json.out">out/get_json.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>status code: 200
body as text: 107 bytes
body as JSON:
{&#39;first&#39;: &#39;Start where you are&#39;, &#39;second&#39;: &#39;Use what you have&#39;, &#39;third&#39;: &#39;Help who you can&#39;}
</code></pre></div>
</div>
<ul>
<li>Parsing data out of HTML is called <a href="#g:web_scraping">web scraping</a><ul>
<li>Painful and error prone</li>
</ul>
</li>
<li>Better to have the server return data as data<ul>
<li>Preferred format these days is <a href="#g:json">JSON</a></li>
<li>So common that <code>requests</code> has built-in support</li>
</ul>
</li>
<li>There is no standard for representing tabular data as JSON<ul>
<li>A list with one list with column names + N lists of values</li>
<li>A list with N dictionaries, all with the same keys</li>
<li>A dictionary with column names and lists of values, all the same length</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 12</strong>:
Write a <code>requests</code> script that gets the current location and crew roster
of <a href="http://api.open-notify.org/">the International Space Station</a>.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Local Web Server</h2>
<p class="inclusion"><a href="src/local_server.sh">src/local_server.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span>-d<span class="w"> </span>site
</code></pre></div>
</div>
<ul>
<li>Pushing files to GitHub so that we can use them is annoying</li>
<li>And we want to show how to make things <em>wrong</em> so that we can then make them <em>right</em></li>
<li>Use Python&rsquo;s <a href="https://docs.python.org/3/library/http.server.html"><code>http.server</code></a> module
    to run a <a href="#g:local_server">local server</a><ul>
<li>Host name is <a href="#g:localhost"><code>localhost</code></a></li>
<li>Uses <a href="#g:port">port</a> 8000 by default</li>
<li>So URLs look like <code>http://localhost:8000/path/to/file</code></li>
</ul>
</li>
<li><code>-d site</code> tells the server to use <code>site</code> as its root directory</li>
<li>Use this local server for the next few examples<ul>
<li>Build our own server later on to show how it works</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">35: Talk to Local Server</h2>
<p class="inclusion"><a href="src/get_local.py">src/get_local.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000/motto.txt&quot;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;body:</span><span class="se">\n</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_local.out">out/get_local.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>::ffff:127.0.0.1 - - [18/Feb/2024 09:12:24] &quot;GET /motto.txt HTTP/1.1&quot; 200 -
status code: 200
body:
Start where you are, use what you have, help who you can.
</code></pre></div>
</div>
<ul>
<li><a href="#g:concurrency">Concurrent</a> systems are hard to debug<ul>
<li>Multiple streams of activity</li>
<li>Order may change from run to run</li>
</ul>
</li>
<li>Use <code>S</code> and <code>c</code> to show output from server and client respectively</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">36: Our Own File Server</h2>
<p class="inclusion"><a href="src/file_server_unsafe.py">src/file_server_unsafe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">url_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; =&gt; &#39;</span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> not file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Our <code>RequestHandler</code> handles a single HTTP request<ul>
<li>More specifically, handles the <code>GET</code> method</li>
</ul>
</li>
<li>Combine working directory with requested file path to get local path to file</li>
<li>Return that if it exists and is a file or raise an error</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">37: Support Code</h2>
<ul>
<li>Send content</li>
</ul>
<p class="inclusion"><a href="src/file_server_unsafe.py">src/file_server_unsafe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">send_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Handle errors</li>
</ul>
<p class="inclusion"><a href="src/file_server_unsafe.py">src/file_server_unsafe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="n">ERROR_PAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">  &lt;head&gt;&lt;title&gt;Error accessing </span><span class="si">{path}</span><span class="s2">&lt;/title&gt;&lt;/head&gt;</span>
<span class="s2">  &lt;body&gt;</span>
<span class="s2">    &lt;h1&gt;Error accessing </span><span class="si">{path}</span><span class="s2">: </span><span class="si">{msg}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">  &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/file_server_unsafe.py">src/file_server_unsafe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">ERROR_PAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Define our own exceptions so we&rsquo;re sure we&rsquo;re only catching what we expect</li>
</ul>
<p class="inclusion"><a href="src/file_server_unsafe.py">src/file_server_unsafe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ServerException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">38: Running Our File Server</h2>
<p class="inclusion"><a href="src/file_server_unsafe.py">src/file_server_unsafe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;serving in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<ul>
<li>And then get <code>motto.txt</code> as before</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">39: Built-in Safety</h2>
<ul>
<li>Modify <code>requests</code> script to take URL as command-line parameter</li>
</ul>
<p class="inclusion"><a href="src/get_url.py">src/get_url.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">URL</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;body:</span><span class="se">\n</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Add a sub-directory to <code>site</code> called <code>sandbox</code> with a file <code>example.txt</code></li>
<li>Serve that sub-directory</li>
</ul>
<p class="inclusion"><a href="src/file_server_sandbox.sh">src/file_server_sandbox.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/file_server_unsafe.py<span class="w"> </span>site/sandbox
</code></pre></div>
</div>
<ul>
<li>Can get files from that directory</li>
</ul>
<p class="inclusion"><a href="src/get_url_allowed.sh">src/get_url_allowed.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/get_url.py<span class="w"> </span>http://localhost:8000/example.txt
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_url_allowed_server.out">out/get_url_allowed_server.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>&#39;/example.txt&#39; =&gt; &#39;/tut/safety/site/sandbox/example.txt&#39;
127.0.0.1 - - [21/Feb/2024 06:04:32] &quot;GET /example.txt HTTP/1.1&quot; 200 -
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_url_allowed_client.out">out/get_url_allowed_client.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>status code: 200
body:
example file
</code></pre></div>
</div>
<ul>
<li>But not from parent directory (which isn&rsquo;t part of sandbox)</li>
</ul>
<p class="inclusion"><a href="src/get_url_disallowed.sh">src/get_url_disallowed.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/requests_local_url.py<span class="w"> </span>http://localhost:8000/motto.txt
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_url_disallowed_server.out">out/get_url_disallowed_server.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>&#39;/motto.txt&#39; =&gt; &#39;/tut/safety/site/sandbox/motto.txt&#39;
127.0.0.1 - - [21/Feb/2024 06:04:38] &quot;GET /motto.txt HTTP/1.1&quot; 404 -
</code></pre></div>
</div>
<p class="inclusion"><a href="out/get_url_disallowed_client.out">out/get_url_disallowed_client.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>status code: 404
body:
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;Error accessing /motto.txt&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Error accessing /motto.txt: /motto.txt not found&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
</div>
<ul>
<li>But why not?</li>
<li>Looks like <code>requests</code> is stripping the leading <code>..</code> off the path</li>
<li>And if we try that URL in the browser, same thing happens</li>
<li>So we&rsquo;re safe, right?</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">40: Introducing netcat</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Netcat"><code>netcat</code></a> (often just <code>nc</code>) is a computer networking tool</li>
<li>Open a connection, send exactly what the user types, and show exactly what is sent in response</li>
</ul>
<p class="inclusion"><a href="src/nc_localhost.sh">src/nc_localhost.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span>localhost<span class="w"> </span><span class="m">8000</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/nc_allowed.text">src/nc_allowed.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>GET /example.txt HTTP/1.1
</code></pre></div>
</div>
<p class="inclusion"><a href="out/nc_allowed.out">out/nc_allowed.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>HTTP/1.0 200 OK
Server: BaseHTTP/0.6 Python/3.12.1
Date: Thu, 22 Feb 2024 18:37:37 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 13

example file
</code></pre></div>
</div>
<ul>
<li>So far so good, but:</li>
</ul>
<p class="inclusion"><a href="src/nc_disallowed.text">src/nc_disallowed.text</a></p>
<div class="language-text">
<div class="highlight"><pre><span></span><code>GET ../motto.txt HTTP/1.1
</code></pre></div>
</div>
<p class="inclusion"><a href="out/nc_disallowed.out">out/nc_disallowed.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>HTTP/1.0 200 OK
Server: BaseHTTP/0.6 Python/3.12.1
Date: Thu, 22 Feb 2024 18:38:50 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 58

Start where you are, use what you have, help who you can.
</code></pre></div>
</div>
<ul>
<li>We shouldn&rsquo;t be able to see files outside the sandbox</li>
<li>But if someone doesn&rsquo;t strip out the <code>..</code> characters, users can escape</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 13</strong>:
The shortcut <code>~<em>username</em></code> means &ldquo;the specified user&rsquo;s home directory&rdquo; in the shell,
while <code>~</code> on its own means &ldquo;the current user&rsquo;s home directory&rdquo;.
create a file called <code>test.txt</code> in your home directory
and then try to get <code>~/test.txt</code> using your browser,
<code>requests</code>,
and Telnet.
What happens with each and why?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">41: A Safer File Server</h2>
<p class="inclusion"><a href="src/file_server_safe.py">src/file_server_safe.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
            <span class="n">sandbox</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sandbox</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot access </span><span class="si">{</span><span class="n">given_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find </span><span class="si">{</span><span class="n">given_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot read </span><span class="si">{</span><span class="n">given_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li><a href="#g:resolve_path">Resolve</a> the constructed path</li>
<li>Check that it&rsquo;s below the current working directory (i.e., the sandbox)</li>
<li>Fail if not<ul>
<li>Using <code>ServerException</code> guarantees that all errors are handled the same way</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 14</strong>:
<a href="#g:refactor">Refactor</a> the <code>do_GET</code> and <code>handle_file</code> methods in <code>RequestHandler</code>
so that all checks are in one place.
Does this make the code easier to understand overall?
Do you think making code easier to understand also makes it safer?</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">42: Serving Data</h2>
<ul>
<li>Rarely have JSON lying around as <a href="#g:static_file">static files</a></li>
</ul>
<p class="inclusion"><a href="src/birds_head.sh">src/birds_head.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>head<span class="w"> </span>-n<span class="w"> </span><span class="m">10</span><span class="w"> </span>site/birds.csv
</code></pre></div>
</div>
<p class="inclusion"><a href="out/birds_head.out">out/birds_head.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>loc_id,latitude,longitude,region,year,month,day,species_id,num
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,1,redcro,3.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,1,rebnut,1.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,1,comred,13.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,1,dowwoo,1.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,1,bkcchi,3.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,1,haiwoo,1.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,8,nobird,
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,15,rebnut,2.0
L13476859,60.8606726,-135.2015181,CA-YT,2021,2,15,bkcchi,3.0
</code></pre></div>
</div>
<ul>
<li>Modify server to generate it dynamically</li>
<li>Main program</li>
</ul>
<p class="inclusion"><a href="src/bird_server_whole.py">src/bird_server_whole.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">sandbox</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sandbox</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">BirdServer</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<ul>
<li>Create our own server class because we want to pass the dataframe in the constructor</li>
</ul>
<p class="inclusion"><a href="src/bird_server_whole.py">src/bird_server_whole.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BirdServer</span><span class="p">(</span><span class="n">HTTPServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">server_address</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</code></pre></div>
</div>
<ul>
<li><code>do_GET</code> converts the dataframe to JSON (will modify later to do more than this)</li>
</ul>
<p class="inclusion"><a href="src/bird_server_whole.py">src/bird_server_whole.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">row_oriented</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li><code>send_content</code> <a href="#g:character_encoding">encodes</a> the JSON string as <a href="#g:utf_8">UTF-8</a>
    and sets the MIME type to <code>application/json</code></li>
</ul>
<p class="inclusion"><a href="src/bird_server_whole.py">src/bird_server_whole.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">send_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/json; charset=utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Can view in browser at <code>http://localhost:8000</code> or use <code>requests</code> to fetch as before</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">43: Slicing Data</h2>
<ul>
<li>URL can contain <a href="#g:query_parameter">query parameters</a></li>
<li>Want <code>http://localhost:8000/?year=2021&amp;species=rebnut</code> to select red-breasted nuthatches in 2021</li>
<li>Put slicing in a method of its own</li>
</ul>
<p class="inclusion"><a href="src/bird_server_slice.py">src/bird_server_slice.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
        <span class="n">as_json</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">as_json</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Use <code>urlparse</code> and <code>parse_qs</code> from <a href="https://docs.python.org/3/library/urllib.parse.html"><code>urllib.parse</code></a> to get query parameters<ul>
<li>(Key, list) dictionary</li>
</ul>
</li>
<li>Then filter data as requested</li>
</ul>
<p class="inclusion"><a href="src/bird_server_slice.py">src/bird_server_slice.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">if</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;species_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">species</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;year&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="exercise">
<h2 class="exercise">Practice</h2>
<p><strong>Exercise 15</strong>:
Write a function that takes a URL as input
and returns a dictionary whose keys are the query parameters&rsquo; names
and whose values are lists of their values.
Do you now see why you should use the library function to do this?</p>
<p><strong>Exercise 16</strong>:
Modify the server so that clients can specify which columns they want returned
as a comma-separated list of names.
If the client asks for a column that doesn&rsquo;t exist, ignore it.</p>
<p><strong>Exercise 17</strong>:
Modify your solution to the previous exercise so that
if the client asks for a column that doesn&rsquo;t exist
the server returns a status code 400 (Bad Request)
and a JSON blog with two keys:
<code>status_code</code> (set to 400)
and <code>error_message</code> (set to something informative).
Explain why the server should return JSON rather than HTML in the case of an error.</p>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">44: What&rsquo;s the Magic Word?</h2>
<ul>
<li>Only allow access to data if client:<ul>
<li><a href="#g:authentication">Authenticates</a> (i.e., establishes their identity)</li>
<li>Is <a href="#g:authorization">authorized</a> (i.e., has the right to view the data)</li>
</ul>
</li>
<li>Simplest possible is wrong in many ways: does the client know a password?</li>
</ul>
<p class="inclusion"><a href="src/bird_client_password.py">src/bird_client_password.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000?species=stejay&quot;</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Password&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2"> records returned&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/bird_client_password_correct.sh">src/bird_client_password_correct.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/bird_client_password.py<span class="w"> </span>mumble
</code></pre></div>
</div>
<p class="inclusion"><a href="out/bird_client_password_correct.out">out/bird_client_password_correct.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>16 records returned
</code></pre></div>
</div>
<p class="inclusion"><a href="src/bird_client_password_incorrect.sh">src/bird_client_password_incorrect.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/bird_client_password.py<span class="w"> </span>bad_password
</code></pre></div>
</div>
<p class="inclusion"><a href="out/bird_client_password_incorrect.out">out/bird_client_password_incorrect.out</a></p>
<div class="language-plaintext">
<div class="highlight"><pre><span></span><code>403: incorrect or missing password
</code></pre></div>
</div>
<ul>
<li>First change to server: get the password on the command line and save it</li>
</ul>
<p class="inclusion"><a href="src/bird_server_password.py">src/bird_server_password.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">sandbox</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sandbox</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">BirdServer</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/bird_server_password.py">src/bird_server_password.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BirdServer</span><span class="p">(</span><span class="n">HTTPServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">server_address</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">password</span>
</code></pre></div>
</div>
<ul>
<li>Second change: add authorization to <code>do_GET</code><ul>
<li>Once again use our own exception class to handle unhappy cases</li>
</ul>
</li>
</ul>
<p class="inclusion"><a href="src/bird_server_password.py">src/bird_server_password.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorize</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
            <span class="n">as_json</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">as_json</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ServerException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Add authorization that checks header value</li>
</ul>
<p class="inclusion"><a href="src/bird_server_password.py">src/bird_server_password.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_password</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="s2">&quot;incorrect or missing password&quot;</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">FORBIDDEN</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Handle errors by constructing JSON</li>
</ul>
<p class="inclusion"><a href="src/bird_server_password.py">src/bird_server_password.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">exc</span><span class="o">.</span><span class="n">_status</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>It works but:<ul>
<li>One password for everyone</li>
<li>Sent as <a href="#g:cleartext">cleartext</a> over an unencrypted connection</li>
</ul>
</li>
</ul>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="topic">
<h2 class="topic">45: Basic Authentication</h2>
<ul>
<li>Modify <code>do_GET</code></li>
</ul>
<p class="inclusion"><a href="src/bird_server_basicauth.py">src/bird_server_basicauth.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorize</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
            <span class="n">as_json</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">as_json</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ServerException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic HTTP authentication</a>:<ul>
<li>Header called <code>"Authorization"</code></li>
<li>Value is <code>Basic <em>data</em></code></li>
<li>Data is <a href="#g:base64">base-64 encoded</a> <code><em>username</em>:<em>password</em></code></li>
</ul>
</li>
<li>Most of the code is checking that everything is OK and responding properly if it&rsquo;s not</li>
<li>Test client</li>
</ul>
<p class="inclusion"><a href="src/bird_client_basicauth.py">src/bird_client_basicauth.py</a></p>
<div class="language-py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000?species=stejay&quot;</span>

<span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2"> records returned&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="inclusion"><a href="src/bird_client_basicauth_correct.sh">src/bird_client_basicauth_correct.sh</a></p>
<div class="language-sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/bird_client_basicauth.py<span class="w"> </span>marlyn<span class="w"> </span>mumble
</code></pre></div>
</div>
<!-- ---------------------------------------------------------------- -->
</section>
<section class="aside">
<h2 class="aside">Appendices</h2>
<h3>Terms</h3>
<dl class="glossary">
<dt id="g:ascii">ASCII character encoding</dt><dd>A standard way to represent the characters commonly used in the Western European languages as 7-bit integers, now largely superceded by <a href="#unicode">Unicode</a>.</dd>

<dt id="g:authentication">authentication</dt><dd>The act of establishing one&rsquo;s identity.</dd>

<dt id="g:authorization">authorization</dt><dd>The act of establishing that one has a right to access certain information.</dd>

<dt id="g:background_process">background a process</dt><dd>To disconnect a <a href="#process">process</a> from the terminal but keep it running.</dd>

<dt id="g:base64">base64 encoding</dt><dd>A representation of binary data that represents each group of 6 bits as one of 64 printable characters.</dd>

<dt id="g:cache">cache</dt><dd>To store a copy of data locally in order to speed up access, or the data being stored.</dd>

<dt id="g:callback_function">callback function</dt><dd>A function A that is passed to another function B so that B can call it at some later point.</dd>

<dt id="g:character_encoding">character encoding</dt><dd>A way to represent characters as bytes. Common examples include <a href="#ascii">ASCII</a> and <a href="#utf_8">UTF-8</a>.</dd>

<dt id="g:child_process">child process</dt><dd>A <a href="#process">process</a> created by another process, which is called its <a href="#parent_process">parent process</a>.</dd>

<dt id="g:cleartext">cleartext</dt><dd>Text that has not been <a href="#encryption">encrypted</a>.</dd>

<dt id="g:client">client</dt><dd>A program such as a browser that sends requests to a server and does something with the response.</dd>

<dt id="g:concurrency">concurrency</dt><dd>The ability of different parts of a system to take action at the same time.</dd>

<dt id="g:daemon">daemon</dt><dd>A long-lived process managed by an operating system that provides a service such as printer management to other processes.</dd>

<dt id="g:docker_container">Docker container</dt><dd>A particular running (or runnable) instance of a <a href="#docker_image">Docker image</a>.</dd>

<dt id="g:docker_image">Docker image</dt><dd>A package containing the software and supporting files needed to run an application in isolation.</dd>

<dt id="g:dynamic_content">dynamic content</dt><dd>Web site content that is generated on the fly. Dynamic content is usually customized according to the requester&rsquo;s identity, <a href="#query_parameter">query parameter</a>, etc.</dd>

<dt id="g:encryption">encryption</dt><dd>The process of converting data from a representation that anyone can read to one that can only be read by someone with the right algorithm and/or key.</dd>

<dt id="g:env_var">environment variable</dt><dd>A <a href="#shell_var">shell variable</a> that is inherited by <a href="#child_process">child processes</a></dd>

<dt id="g:filesystem">filesystem</dt><dd>The set of files and directories making up a computer&rsquo;s permanent storage, or the software component used to manage them.</dd>

<dt id="g:foreground_process">foreground a process</dt><dd>To reconnect a <a href="#process">process</a> to the terminal after it has been <a href="#background_process">backgrounded</a> or <a href="#suspend_process">suspended</a>.</dd>

<dt id="g:fork_process">fork (a process)</dt><dd>To create a duplicate of an existing <a href="#process">process</a>, typically in order to run a new program.</dd>

<dt id="g:http_header">header (of HTTP request or response)</dt><dd>A name-value pair at the start of an <a href="#http_request">HTTP request</a> or <a href="#http_response">response</a>. Headers are used to specify what data formats the sender can handle, the date and time the message was sent, and so on.</dd>

<dt id="g:hostname">hostname</dt><dd>A human-readable name for a computer on a network.</dd>

<dt id="g:http">HTTP</dt><dd>The protocol used to exchange information between browsers and websites, and more generally between other clients and servers. Communication consists of <a href="#http_request">requests</a> and <a href="#http_response">responses</a>.</dd>

<dt id="g:http_method">HTTP method</dt><dd>The verb in an <a href="#http_request">HTTP request</a> that defines what the <a href="#client">client</a> wants to do. Common methods are <code>GET</code> (to get data) and <code>POST</code> (to submit data).</dd>

<dt id="g:http_request">HTTP request</dt><dd>A precisely-formatted block of text sent from a <a href="#client">client</a> such as a browser to a <a href="#server">server</a> that specifies what resource is being requested, what data formats the client will accept, etc.</dd>

<dt id="g:http_response">HTTP response</dt><dd>A precisely-formatted block of text sent from a <a href="#server">server</a> back to a <a href="#client">client</a> in reply to a <a href="#http_request">request</a>.</dd>

<dt id="g:http_status_code">HTTP status code</dt><dd>A numerical code that indicates what happened when an <a href="#http_request">HTTP request</a> was processed, such as 200 (OK), 404 (not found), or 500 (internal server error).</dd>

<dt id="g:json">JavaScript Object Notation (JSON)</dt><dd>A way to represent data by combining basic values like numbers and character strings in lists and key-value structures. Unlike other formats, it is unencumbered by a syntax for writing comments.</dd>

<dt id="g:local_server">local server</dt><dd>A <a href="#server">server</a> running on the programmer&rsquo;s own computer, typically for development purposes.</dd>

<dt id="g:localhost">localhost</dt><dd>A special <a href="#hostname">host name</a> that identifies the computer that the software is running on.</dd>

<dt id="g:mime_type">MIME type</dt><dd>A standard that defines types of file content, such as <code>text/plain</code> for plain text and <code>image/jpeg</code> for JPEG images.</dd>

<dt id="g:parent_process">parent process</dt><dd>A <a href="#process">process</a> which has created one or more other processes, which are called its <a href="#child_process">child processes</a>.</dd>

<dt id="g:path">path (in filesystem)</dt><dd>An expression that refers to a file or directory in a filesystem.</dd>

<dt id="g:port">port</dt><dd>A logical endpoint for communication, like a phone number in an office building.</dd>

<dt id="g:process">process</dt><dd>A running instance of a program.</dd>

<dt id="g:process_id">process ID</dt><dd>The unique numerical identifier of a running <a href="#process">process</a>.</dd>

<dt id="g:process_tree">process tree</dt><dd>The set of processes created directly or indirectly by one process and the <a href="#parent_process">parent</a>-<a href="#child_process">child</a> relationships between them.</dd>

<dt id="g:query_parameter">query parameter</dt><dd>A key-value pair included in a URL that the server may use to modify or customize its response.</dd>

<dt id="g:refactor">refactor</dt><dd>To reorganize code without changing its overall behavior.</dd>

<dt id="g:resolve_path">resolve (a path)</dt><dd>To translate a <a href="#path">path</a> into the canonical name of the file or directory it refers to.</dd>

<dt id="g:resume_process">resume (a process)</dt><dd>To continue the execution of a <a href="#suspend_process">suspended</a> <a href="#process">process</a>.</dd>

<dt id="g:root_user">root (user account)</dt><dd>The usual ID of the <a href="#superuser">superuser</a> account on a computer.</dd>

<dt id="g:root_directory">root directory</dt><dd>The top-most directory in the <a href="#filesystem">filesystem</a> that contains all other directories and files.</dd>

<dt id="g:server">server</dt><dd>A program that waits for requests from <a href="#client">clients</a> and sends them data in response.</dd>

<dt id="g:shell">shell</dt><dd>A program that allows a user to interact with a computer&rsquo;s operating system and other programs through a textual user interface.</dd>

<dt id="g:shell_var">shell variable</dt><dd>A variable set and used in the <a href="#shell">shell</a>.</dd>

<dt id="g:shell_script">shell_script</dt><dd>A program that uses <a href="#shell">shell</a> commands as its programming language.</dd>

<dt id="g:signal">signal</dt><dd>A message sent to a running <a href="#process">process</a> separate from its normal execution, such as an interrupt or a timer notification.</dd>

<dt id="g:signal_handler">signal handler</dt><dd>A <a href="#callback_function">callback function</a> that is called when a <a href="#process">process</a> receives a <a href="#signal">signal</a>.</dd>

<dt id="g:source_shell">source (in shell script)</dt><dd>To run one <a href="#shell_script">shell script</a> in the same process as another.</dd>

<dt id="g:static_file">static file</dt><dd>Web site content that is stored as a file on disk that is served as-is. Serving static files is usually faster than generating <a href="#dynamic_content">dynamic content</a>, but can only be done if what&rsquo;s wanted is unchanging and known in advance.</dd>

<dt id="g:superuser">superuser</dt><dd>An administrative account on a computer that has permission to see, change, and run everything.</dd>

<dt id="g:suspend_process">suspend (a process)</dt><dd>To pause the execution of a <a href="#process">process</a> but leave it intact so that it can <a href="#resume_process">resume</a> later.</dd>

<dt id="g:unicode">Unicode</dt><dd>A standard that defines numeric codes for many thousands of characters and symbols. Unicode does not define how those numbers are stored; that is done by standards like <a href="#utf_8">UTF-8</a>.</dd>

<dt id="g:utf_8">UTF-8</dt><dd>A way to store the numeric codes representing <a href="#unicode">Unicode</a> characters that is backward-compatible with the older <a href="#ascii">ASCII</a> standard.</dd>

<dt id="g:virtual_env">virtual environment</dt><dd>A set of libraries, applications, and other resources that are isolated from the main system and other virtual environments.</dd>

<dt id="g:web_scraping">web scraping</dt><dd>The act of extracting data from HTML pages on the web.</dd>
</dl>
<h3>Acknowledgments</h3>
<ul><li>Stefan Arentz</li>
<li>Julia Evans</li>
<li>Robert Kern</li>
<li>Matt Panaro</li>
<li>Jean-Marc Saffroy</li>
</ul>
<h3>Links</h3>
<ul>
<li><em>Teaching Tech Together</em>: <a href="https://teachtogether.tech/">https://teachtogether.tech/</a></li>
<li><em>Teaching Tech Together</em> lesson on learner personas: <a href="http://teachtogether.tech/en/index.html#s:process-personas">http://teachtogether.tech/en/index.html#s:process-personas</a></li>
<li>Basic HTTP authentication: <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">https://en.wikipedia.org/wiki/Basic_access_authentication</a></li>
<li>Docker: <a href="https://www.docker.com/">https://www.docker.com/</a></li>
<li>Docker Hub: <a href="https://hub.docker.com/">https://hub.docker.com/</a></li>
<li>Go programming language: <a href="https://go.dev/">https://go.dev/</a></li>
<li>Open Notify API for the International Space Station: <a href="http://api.open-notify.org/">http://api.open-notify.org/</a></li>
<li>Pandas dataframe library: <a href="https://pandas.pydata.org/">https://pandas.pydata.org/</a></li>
<li>Polars dataframe library: <a href="https://pola.rs/">https://pola.rs/</a></li>
<li>Python <code>http.server</code> module: <a href="https://docs.python.org/3/library/http.server.html">https://docs.python.org/3/library/http.server.html</a></li>
<li>Python <code>urllib.parse</code> module: <a href="https://docs.python.org/3/library/urllib.parse.html">https://docs.python.org/3/library/urllib.parse.html</a></li>
<li>Software Carpentry lesson on Git: <a href="https://swcarpentry.github.io/git-novice/">https://swcarpentry.github.io/git-novice/</a></li>
<li>Software Carpentry lesson on the Unix shell: <a href="https://swcarpentry.github.io/shell-novice/">https://swcarpentry.github.io/shell-novice/</a></li>
<li>The Carpentries: <a href="https://carpentries.org/">https://carpentries.org/</a></li>
<li>Wikipedia article on HTTP status codes: <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">https://en.wikipedia.org/wiki/List_of_HTTP_status_codes</a></li>
<li><code>requests</code> module: <a href="https://requests.readthedocs.io/en/latest/">https://requests.readthedocs.io/en/latest/</a></li>
<li>netcat: <a href="https://en.wikipedia.org/wiki/Netcat">https://en.wikipedia.org/wiki/Netcat</a></li>
<li>pip package manager for Python: <a href="https://pip.pypa.io/en/stable/">https://pip.pypa.io/en/stable/</a></li>
</ul>
<h3>To Do</h3>
<ul>
<li>How can I find things on my system?<ul>
<li><code>find | xargs</code> and alternatives</li>
</ul>
</li>
<li>How can I found out what kind of system I&rsquo;m using (<code>uname</code>)</li>
<li>How do I see who has accounts on a machine?</li>
<li>How do I create a new account?</li>
<li>How do I delete an account?</li>
<li>How do I see who owns a file?</li>
<li>What does it actually mean to own a file?</li>
<li>What other kinds of permissions are there?</li>
<li>How can I specify what program to use to run a file?</li>
<li>How can I tell what kind of file a file is?</li>
<li>How can I see what&rsquo;s using a computer&rsquo;s processor/memory/disk/network?</li>
<li>How are files and directories stored (i.e., what is an inode)?</li>
<li>How can I see how much disk space is in use (<code>df</code>, <code>du</code>)?</li>
<li>When is a file not a file?</li>
<li>How can I create a shortcut (link) for a file?</li>
<li>What is a port?</li>
<li>How can I tell which ports are being used and by which processes?</li>
<li>How can I run a job repeatedly (<code>cron</code> and <code>watch</code>)?</li>
<li>What is a process group?</li>
<li>What are keys and how do I manage them?</li>
<li>What are certificates and how do I manage them?</li>
<li>How can I run a web server?</li>
<li>What other services might I want to run, when, and why?</li>
<li>How can I check my network connection (ping, traceroute)?</li>
<li>What is an IP address?</li>
<li>How can I connect to another computer (ssh)?</li>
<li>What is a user group and why do I care?</li>
<li>How can I view the computer&rsquo;s system log and what will I find there?</li>
<li>What are alternatives to classic password authentication?</li>
</ul>
</section>
    </main>
    <footer>
  <i class="fa fa-copyright"></i> 2024 Greg Wilson
  &middot;
  <a href="mailto:gvwilson@third-bit.com"><i class="fas fa-envelope-square" aria-hidden="true" title="author email"></i></a>
  <a href="https://github.com/gvwilson/sys-tutorial"><i class="fab fa-github" aria-hidden="true" title="GitHub repository"></i></a>
  <a href="license/"><i class="fab fa-creative-commons-by" aria-hidden="true" title="license"></i></a>
  &middot;
  <i class="fas fa-clock"></i>
  <time datetime="2024-03-25">Last built 2024-03-25</time>
  &middot;
  <i class="fas fa-user-check"></i> 100% human content
</footer>

  </body>
</html>
