<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="../logo.svg">
<link rel="stylesheet" href="../mccole.css" type="text/css">
<title>The Sudonomicon &middot; Virtualization</title>
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  <script defer data-domain="gvwilson.github.io/sys-tutorial" src="https://plausible.io/js/plausible.js"></script>


  </head>
  <body>
    <main>
      
<h1>Virtualization</h1>


      <div class="row notex">
  <div class="col-1 left">
    <a href="../http/">&lArr;</a>
  </div>
  <div class="col-10 center">
    <span class="tagline"></span>
  </div>
  <div class="col-1 right">
    <a href="../finale/">&rArr;</a>
  </div>
</div>

      <ul class="keypoints">
<li>FIXME</li>
</ul>
      <p class="terms">Terms defined: 
<a class="gl-ref" href="../glossary/#gl:authentication" markdown="1">authentication</a>, <a class="gl-ref" href="../glossary/#gl:authorization" markdown="1">authorization</a>, <a class="gl-ref" href="../glossary/#gl:base64" markdown="1">base64 encoding</a>, <a class="gl-ref" href="../glossary/#gl:cache" markdown="1">cache</a>, <a class="gl-ref" href="../glossary/#gl:cleartext" markdown="1">cleartext</a>, <a class="gl-ref" href="../glossary/#gl:daemon" markdown="1">daemon</a>, <a class="gl-ref" href="../glossary/#gl:docker_container" markdown="1">Docker container</a>, <a class="gl-ref" href="../glossary/#gl:docker_image" markdown="1">Docker image</a>, <a class="gl-ref" href="../glossary/#gl:root_directory" markdown="1">root directory</a>, <a class="gl-ref" href="../glossary/#gl:root_user" markdown="1">root (user account)</a>, <a class="gl-ref" href="../glossary/#gl:superuser" markdown="1">superuser</a>, <a class="gl-ref" href="../glossary/#gl:virtual_env" markdown="1">virtual environment</a>
</p>
      <h2>Virtual Environments</h2>
<ul>
<li>If two directories <code>A</code> and <code>B</code> contain a program <code>xyz</code> and <code>A</code> comes before <code>B</code>,
    <code>xyz</code> on its own will run <code>A/xyz</code> instead of <code>B/xyz</code></li>
<li>This is how <a class="gl-ref" href="../glossary/#gl:virtual_env" markdown="1">virtual environments</a> work</li>
</ul>
<div class="code-sample language-sh" title="show_virtual_env.sh">
<div class="highlight"><pre><span></span><code><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>:<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>conda
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;python is&quot;</span><span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>python<span class="k">)</span>
</code></pre></div>
</div>
<div class="code-sample language-out" title="show_virtual_env.out">
<div class="highlight"><pre><span></span><code>/Users/tut/conda/envs/sys/bin
/Users/tut/conda/condabin
python is /Users/tut/conda/envs/sys/bin/python
</code></pre></div>
</div>
<ul>
<li>Virtual environment is initially a minimal Python installation</li>
<li>Installing new packages puts them in the environment&rsquo;s directory</li>
</ul>
<h2>Package Installation</h2>
<ol>
<li>Create a new virtual environment called <code>example</code>: <code>conda create -n example python=3.12</code></li>
<li>Activate that virtual environment: <code>conda activate example</code></li>
<li>Install the <code>faker</code> package: <code>pip install faker</code></li>
</ol>
<div class="code-sample language-sh" title="find_faker.sh">
<div class="highlight"><pre><span></span><code>find<span class="w"> </span><span class="nv">$HOME</span>/conda/envs/example<span class="w"> </span>-name<span class="w"> </span>faker
</code></pre></div>
</div>
<div class="code-sample language-out" title="find_faker.out">
<div class="highlight"><pre><span></span><code>/Users/tut/conda/envs/example/bin/faker
/Users/tut/conda/envs/example/lib/python3.12/site-packages/faker
</code></pre></div>
</div>
<ul>
<li>The script in <code>bin</code> loads the module and runs it</li>
</ul>
<div class="code-sample language-py" title="faker_bin.py">
<div class="highlight"><pre><span></span><code><span class="ch">#!/Users/gregwilson/conda/envs/example/bin/python3.12</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">faker.cli</span> <span class="kn">import</span> <span class="n">execute_from_command_line</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(-script\.pyw|\.exe)?$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">execute_from_command_line</span><span class="p">())</span>
</code></pre></div>
</div>
<ul>
<li>The directory under <code>site-packages</code> has 642 Python files (as of version 24.3.0)</li>
<li>The <code>python</code> in the virtual environment&rsquo; <code>bin</code> directory
    knows to look in that environment&rsquo;s <code>site-packages</code> directory</li>
</ul>
<h2 class="aside">Limits of Virtual Environments</h2>
<ul>
<li><code>conda</code> and <code>python -m venv</code> work for Python</li>
<li>But what about Rust, JavaScript, and other languages?</li>
<li>In particular, what if you need an isolated environment for several languages at once?</li>
<li>And you want other people to be able to reproduce it?</li>
<li>We will build something worth installing and then return to this problem</li>
</ul>
<h2>What&rsquo;s the Magic Word?</h2>
<ul>
<li>Only allow access to data if client:<ul>
<li><a class="gl-ref" href="../glossary/#gl:authentication" markdown="1">Authenticates</a> (i.e., establishes their identity)</li>
<li>Is <a class="gl-ref" href="../glossary/#gl:authorization" markdown="1">authorized</a> (i.e., has the right to view the data)</li>
</ul>
</li>
<li>Simplest possible is wrong in many ways: does the client know a password?</li>
</ul>
<div class="code-sample language-py" title="bird_client_password.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000?species=stejay&quot;</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Password&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2"> records returned&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample language-sh" title="bird_client_password_correct.sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/bird_client_password.py<span class="w"> </span>mumble
</code></pre></div>
</div>
<div class="code-sample language-out" title="bird_client_password_correct.out">
<div class="highlight"><pre><span></span><code>16 records returned
</code></pre></div>
</div>
<div class="code-sample language-sh" title="bird_client_password_incorrect.sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/bird_client_password.py<span class="w"> </span>bad_password
</code></pre></div>
</div>
<div class="code-sample language-out" title="bird_client_password_incorrect.out">
<div class="highlight"><pre><span></span><code>403: incorrect or missing password
</code></pre></div>
</div>
<ul>
<li>First change to server: get the password on the command line and save it</li>
</ul>
<div class="code-sample language-py" title="bird_server_password.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">sandbox</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sandbox</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">serverAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">BirdServer</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">serverAddress</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="code-sample language-py" title="bird_server_password.py">
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BirdServer</span><span class="p">(</span><span class="n">HTTPServer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">server_address</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">password</span>
</code></pre></div>
</div>
<ul>
<li>Second change: add authorization to <code>do_GET</code><ul>
<li>Once again use our own exception class to handle unhappy cases</li>
</ul>
</li>
</ul>
<div class="code-sample language-py" title="bird_server_password.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authorize</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
            <span class="n">as_json</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">as_json</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ServerException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Add authorization that checks header value</li>
</ul>
<div class="code-sample language-py" title="bird_server_password.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_password</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerException</span><span class="p">(</span><span class="s2">&quot;incorrect or missing password&quot;</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">FORBIDDEN</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>Handle errors by constructing JSON</li>
</ul>
<div class="code-sample language-py" title="bird_server_password.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">exc</span><span class="o">.</span><span class="n">_status</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li>It works but:<ul>
<li>One password for everyone</li>
<li>Sent as <a class="gl-ref" href="../glossary/#gl:cleartext" markdown="1">cleartext</a> over an unencrypted connection</li>
</ul>
</li>
</ul>
<h2>Basic Authentication</h2>
<ul>
<li>Modify <code>do_GET</code></li>
</ul>
<div class="code-sample language-py" title="bird_server_basicauth.py">
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorize</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_data</span><span class="p">()</span>
            <span class="n">as_json</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_content</span><span class="p">(</span><span class="n">as_json</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ServerException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</code></pre></div>
</div>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic HTTP authentication</a>:<ul>
<li>Header called <code>"Authorization"</code></li>
<li>Value is <code>Basic <em>data</em></code></li>
<li>Data is <a class="gl-ref" href="../glossary/#gl:base64" markdown="1">base-64 encoded</a> <code><em>username</em>:<em>password</em></code></li>
</ul>
</li>
<li>Most of the code is checking that everything is OK and responding properly if it&rsquo;s not</li>
<li>Test client</li>
</ul>
<div class="code-sample language-py" title="bird_client_basicauth.py">
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000?species=stejay&quot;</span>

<span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2"> records returned&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="code-sample language-sh" title="bird_client_basicauth_correct.sh">
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>src/bird_client_basicauth.py<span class="w"> </span>marlyn<span class="w"> </span>mumble
</code></pre></div>
</div>
<h2>Changing the Root Directory</h2>
<ul>
<li>The <code>chroot</code> command<ul>
<li>Changes the process&rsquo;s idea of the <a class="gl-ref" href="../glossary/#gl:root_directory" markdown="1">root directory</a></li>
<li>Runs a command</li>
</ul>
</li>
<li>But…</li>
</ul>
<div class="code-sample language-sh" title="chroot_example.sh">
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/filesystem
chroot<span class="w"> </span>/tmp/filesystem<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;it worked&quot;</span>
</code></pre></div>
</div>
<div class="code-sample language-out" title="chroot_example.out">
<div class="highlight"><pre><span></span><code>chroot: /tmp/filesystem: Operation not permitted
</code></pre></div>
</div>
<ul>
<li>Need special permission (discussed below)</li>
<li>Everything needed to run <code>echo</code> and other commands needs to be in the new filesystem</li>
<li>Only isolates the filesystem</li>
</ul>
<h2>sudo</h2>
<ul>
<li>Every machine has a <a class="gl-ref" href="../glossary/#gl:superuser" markdown="1">superuser</a> account called <a class="gl-ref" href="../glossary/#gl:root_user" markdown="1">root</a><ul>
<li>Which has nothing to do with the root directory of the filesystem</li>
</ul>
</li>
<li>Use <code>sudo</code> (&ldquo;superuser do&rdquo;) to change identity temporarily</li>
</ul>
<div class="code-sample language-sh" title="sudo_example.sh">
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/filesystem
sudo<span class="w"> </span>chroot<span class="w"> </span>/tmp/filesystem<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;it worked&quot;</span>
</code></pre></div>
</div>
<div class="code-sample language-out" title="sudo_example.out">
<div class="highlight"><pre><span></span><code>Password: ************
chroot: echo: No such file or directory
</code></pre></div>
</div>
<ul>
<li>At least it&rsquo;s a different error message…</li>
<li><code>sudo</code> is a way to give yourself permission to mess up everything on your computer</li>
<li>So another requirement for virtual environments:
    break them without breaking anything else</li>
</ul>
<h2>Docker</h2>
<ul>
<li><a href="https://www.docker.com/">Docker</a> solves all of these problems</li>
<li>Define an <a class="gl-ref" href="../glossary/#gl:docker_image" markdown="1">image</a> with its own copy of the operating system, filesystem, etc.</li>
<li>Run it in a <a class="gl-ref" href="../glossary/#gl:docker_container" markdown="1">container</a> that is isolated from the rest of your computer</li>
</ul>
<div class="code-sample language-sh" title="docker_image_ls.sh">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>image<span class="w"> </span>ls
</code></pre></div>
</div>
<div class="code-sample language-out" title="docker_image_ls.out">
<div class="highlight"><pre><span></span><code>REPOSITORY   TAG       IMAGE ID   CREATED   SIZE
</code></pre></div>
</div>
<div class="code-sample language-sh" title="docker_container_ls.sh">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>container<span class="w"> </span>ls
</code></pre></div>
</div>
<div class="code-sample language-out" title="docker_container_ls.out">
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</code></pre></div>
</div>
<h2 class="aside">Common Error Message</h2>
<ul>
<li>Docker requires a <a class="gl-ref" href="../glossary/#gl:daemon" markdown="1">daemon</a> process to be running in the background to start images</li>
</ul>
<div class="code-sample language-sh" title="docker_image_ls.sh">
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>image<span class="w"> </span>ls
</code></pre></div>
</div>
<div class="code-sample language-out" title="docker_image_ls_err.out">
<div class="highlight"><pre><span></span><code>Cannot connect to the Docker daemon at unix:///Users/tut/.docker/run/docker.sock.
Is the docker daemon running?
</code></pre></div>
</div>
<h2>Running a Container</h2>
<div class="code-sample language-text" title="docker_run_fresh.text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu:latest
Unable to find image &#39;ubuntu:latest&#39; locally
latest: Pulling from library/ubuntu
bccd10f490ab: Pull complete
Digest: sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e
Status: Downloaded newer image for ubuntu:latest

$ docker container ls

$ docker container ls -a
CONTAINER ID   IMAGE           COMMAND       CREATED          STATUS                     PORTS     NAMES
741bb295734f   ubuntu:latest   &quot;/bin/bash&quot;   10 seconds ago   Exited (0) 9 seconds ago             xenodochial_mclaren

$ docker image ls
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
ubuntu       latest    ca2b0f26964c   3 weeks ago   77.9MB
</code></pre></div>
</div>
<ul>
<li>Ask Docker to run a container with <code>ubuntu:latest</code><ul>
<li>I.e., latest stable version of Ubuntu Linux from <a href="https://hub.docker.com/">Docker Hub</a></li>
</ul>
</li>
<li>Docker can&rsquo;t find a <a class="gl-ref" href="../glossary/#gl:cache" markdown="1">cached</a> copy locally, so it downloads the image</li>
<li>Then runs it</li>
<li>But its default command is <code>/bin/bash</code> with no inputs, so it exits immediately.</li>
</ul>
<h2>Re-running a Container</h2>
<div class="code-sample language-text" title="docker_run_again.text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu:latest pwd
/

$ docker container run ubuntu:latest ls
bin
boot
dev
etc
home
…more entries…
sys
tmp
usr
var
</code></pre></div>
</div>
<ul>
<li>Doesn&rsquo;t need to download again</li>
<li>Runs the given command instead of the default <code>/bin/bash</code></li>
</ul>
<h2 class="aside">This Doesn&rsquo;t Work</h2>
<div class="code-sample language-text" title="docker_run_error.text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu:latest &quot;echo hello&quot;
docker: Error response from daemon: \
failed to create task for container: \
failed to create shim task: \
OCI runtime create failed: \
runc create failed: \
unable to start container process: \
exec: &quot;echo hello&quot;: executable file not found in $PATH: unknown.
</code></pre></div>
</div>
<h2 class="aside">Pulling Images</h2>
<ul>
<li>Don&rsquo;t have to run immediately</li>
</ul>
<div class="code-sample language-text" title="docker_pull.text">
<div class="highlight"><pre><span></span><code>$ docker pull ubuntu:latest
latest: Pulling from library/ubuntu
Digest: sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e
Status: Image is up to date for ubuntu:latest
docker.io/library/ubuntu:latest
</code></pre></div>
</div>
<h2>What Have We Got?</h2>
<div class="code-sample language-text" title="os_release.text">
<div class="highlight"><pre><span></span><code>$ docker container run ubuntu cat /etc/os-release
PRETTY_NAME=&quot;Ubuntu 22.04.4 LTS&quot;
NAME=&quot;Ubuntu&quot;
VERSION_ID=&quot;22.04&quot;
VERSION=&quot;22.04.4 LTS (Jammy Jellyfish)&quot;
VERSION_CODENAME=jammy
ID=ubuntu
ID_LIKE=debian
HOME_URL=&quot;https://www.ubuntu.com/&quot;
SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;
BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;
PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;
UBUNTU_CODENAME=jammy
</code></pre></div>
</div>
<ul>
<li>Don&rsquo;t need <code>:latest</code> every time (defaults)</li>
</ul>
<h2>Inside the Container</h2>
<div class="code-sample language-text" title="docker_run_interactive.text">
<div class="highlight"><pre><span></span><code>$ docker container run -i -t ubuntu
root@4238b3b51abd:/# pwd
/
root@4238b3b51abd:/# whoami
root
root@4238b3b51abd:/# ls
bin  boot  dev  etc  home  lib  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
root@4238b3b51abd:/# ^D
exit
$
</code></pre></div>
</div>
<ul>
<li><code>-i</code>: interactive</li>
<li><code>-t</code>: terminal (kind of)<ul>
<li>Combination often abbreviated <code>-it</code></li>
</ul>
</li>
<li>The hexadecimal number after <code>root@</code> is the container&rsquo;s unique ID</li>
</ul>
<h2>Persistence</h2>
<div class="code-sample language-text" title="docker_run_nonpersistent.text">
<div class="highlight"><pre><span></span><code>$ docker container run -i -t ubuntu
root@a8ea570a84d3:/# ls /tmp
root@a8ea570a84d3:/# touch /tmp/proof-we-were-here.txt
root@a8ea570a84d3:/# ls /tmp
proof-we-were-here.txt
root@a8ea570a84d3:/# ^D
exit

$ docker container run -i -t ubuntu
root@f792c15ebb5b:/# ls /tmp
root@f792c15ebb5b:/# ^D
exit
</code></pre></div>
</div>
<ul>
<li>Container starts fresh each time it runs</li>
<li>Notice that the container&rsquo;s ID changes each time it runs</li>
</ul>
<h2>What Is Running</h2>
<div class="code-sample language-text" title="docker_container_ls_id.text">
<div class="highlight"><pre><span></span><code>$ docker container ls --format &quot;table {{.ID}}\t{{.Status}}&quot; |
CONTAINER ID   STATUS                                       |
                                                            |
                                                            | $ docker container run -it ubuntu
                                                            | root@a5427ccdeb26:/#
                                                            |
$ docker container ls --format &quot;table {{.ID}}\t{{.Status}}&quot; |
CONTAINER ID   STATUS                                       |
a5427ccdeb26   Up 38 seconds                                |
                                                            |
                                                            | root@a5427ccdeb26:/# ^D
                                                            | exit
                                                            |
$ docker container ls --format &quot;table {{.ID}}\t{{.Status}}&quot; |
CONTAINER ID   STATUS                                       |
</code></pre></div>
</div>
<ul>
<li><code>docker container ls</code> on its own shows a wide table</li>
<li>Use <a href="https://go.dev/">Go</a> format strings to format output (no, really)</li>
</ul>
<h2>Installing Software</h2>
<div class="code-sample language-text" title="docker_install_python.text">
<div class="highlight"><pre><span></span><code># apt update
…lots of output…

# apt install python3
…lots of output…

# which python

# which python3
/usr/bin/python3

# python3 --version
Python 3.10.12
</code></pre></div>
</div>
<ul>
<li><code>apt update</code> to update available package lists</li>
<li><code>apt install</code> to install the desired package<ul>
<li>Installs lots of dependencies as well</li>
</ul>
</li>
<li>Doesn&rsquo;t create <code>python</code> (note lack of output)</li>
<li>Creates <code>python3</code> instead</li>
<li>Version is most recent in the default repository</li>
<li>But <em>it isn&rsquo;t there the next time we run</em></li>
</ul>
<div class="code-sample language-text" title="docker_install_python_nonpersistent.text">
<div class="highlight"><pre><span></span><code># ^D
exit

$ docker run -it ubuntu

# which python

# ^D
exit
</code></pre></div>
</div>
<h2>Actually Installing Software</h2>
<ul>
<li>Create a Dockerfile<ul>
<li>Usually called that and in a directory of its own</li>
<li>Ours is <code>src/ubuntu_python3/Dockerfile</code></li>
</ul>
</li>
</ul>
<div class="code-sample language-" title="ubuntu_python3/Dockerfile">
<div class="highlight"><pre><span></span><code>FROM ubuntu:latest

RUN apt update
RUN apt install python3 -y
</code></pre></div>
</div>
<ul>
<li>Tell docker to build the image</li>
</ul>
<div class="code-sample language-text" title="ubuntu_python3_build.text">
<div class="highlight"><pre><span></span><code>#0 building with &quot;desktop-linux&quot; instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 99B done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/ubuntu:latest
#2 DONE 1.6s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [1/3] FROM docker.io/library/ubuntu:latest@sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e
#4 resolve docker.io/library/ubuntu:latest@sha256:77906da86b60585ce12215807090eb327e7386c8fafb5402369e421f44eff17e done
#4 DONE 0.0s

#5 [2/3] RUN apt update
#5 CACHED

#6 [3/3] RUN apt install python3 -y
#6 CACHED

#7 exporting to image
#7 exporting layers done
#7 writing image sha256:c06d47d8275d4ef724dad192bf72daaac6b86701a1be40e1ac03f53092201d71 done
#7 naming to docker.io/gvwilson/ubuntu-python3 done
#7 DONE 0.0s
</code></pre></div>
</div>
<ul>
<li><code>CACHED</code> because we&rsquo;ve run this several times while building this tutorial</li>
</ul>
<div class="code-sample language-text" title="ubuntu_python3_run.text">
<div class="highlight"><pre><span></span><code>$ docker container run -it gvwilson/ubuntu-python3
# which python3
/usr/bin/python3
</code></pre></div>
</div>
<h2>Layers</h2>
<div class="code-sample language-text" title="docker_image_history.text">
<div class="highlight"><pre><span></span><code>$ docker image history gvwilson/ubuntu-python3
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
c06d47d8275d   24 hours ago   RUN /bin/sh -c apt install python3 -y # buil…   29.5MB    buildkit.dockerfile.v0
&lt;missing&gt;      24 hours ago   RUN /bin/sh -c apt update # buildkit            45.6MB    buildkit.dockerfile.v0
&lt;missing&gt;      3 weeks ago    /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B
&lt;missing&gt;      3 weeks ago    /bin/sh -c #(nop) ADD file:07cdbabf782942af0…   69.2MB
&lt;missing&gt;      3 weeks ago    /bin/sh -c #(nop)  LABEL org.opencontainers.…   0B
&lt;missing&gt;      3 weeks ago    /bin/sh -c #(nop)  LABEL org.opencontainers.…   0B
&lt;missing&gt;      3 weeks ago    /bin/sh -c #(nop)  ARG LAUNCHPAD_BUILD_ARCH     0B
&lt;missing&gt;      3 weeks ago    /bin/sh -c #(nop)  ARG RELEASE                  0B
</code></pre></div>
</div>
<ul>
<li>Docker images are built in layers</li>
<li>Layers can be shared between images to reduce disk space</li>
</ul>
<div class="code-sample language-text" title="docker_system_df.text">
<div class="highlight"><pre><span></span><code>$ docker system df
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          2         1         144.3MB   144.3MB (100%)
Containers      1         0         34B       34B (100%)
Local Volumes   1         0         0B        0B
Build Cache     22        0         253.2MB   253.2MB
</code></pre></div>
</div>
<ul>
<li>First line (<code>Images</code>) shows actual disk space<ul>
<li>We&rsquo;ll see the original <code>df</code> command again…</li>
</ul>
</li>
</ul>
<h2>Choosing a Command</h2>
<ul>
<li>Add <code>CMD</code> with a list of arguments to specify default command when image runs</li>
</ul>
<div class="code-sample language-" title="python3_interpreter/Dockerfile">
<div class="highlight"><pre><span></span><code>FROM ubuntu:latest

RUN apt update
RUN apt install python3 -y

CMD [&quot;python3&quot;, &quot;--version&quot;]
</code></pre></div>
</div>
<ul>
<li>Build</li>
</ul>
<div class="code-sample language-text" title="python3_interpreter_build.text">
<div class="highlight"><pre><span></span><code>$ docker build -t gvwilson/python3 src/python3_interpreter
[+] Building 0.0s (7/7) FINISHED                                                                             docker:desktop-linux
 =&gt; [internal] load build definition from Dockerfile                                                                         0.0s
 =&gt; =&gt; transferring dockerfile: 129B                                                                                         0.0s
 =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                             0.0s
 =&gt; [internal] load .dockerignore                                                                                            0.0s
 =&gt; =&gt; transferring context: 2B                                                                                              0.0s
 =&gt; [1/3] FROM docker.io/library/ubuntu:latest                                                                               0.0s
 =&gt; CACHED [2/3] RUN apt update                                                                                              0.0s
 =&gt; CACHED [3/3] RUN apt install python3 -y                                                                                  0.0s
 =&gt; exporting to image                                                                                                       0.0s
 =&gt; =&gt; exporting layers                                                                                                      0.0s
 =&gt; =&gt; writing image sha256:68449d61910cb77cabe5f44ffaeda99a3aa3976f597322c32e32ffeed79d41f7                                 0.0s
 =&gt; =&gt; naming to docker.io/gvwilson/python3                                                                                  0.0s
</code></pre></div>
</div>
<ul>
<li>Run</li>
</ul>
<div class="code-sample language-text" title="python3_interpreter_run.text">
<div class="highlight"><pre><span></span><code>$ docker container run gvwilson/python3
Python 3.10.12
</code></pre></div>
</div>
<h2 id="virt-exercises">Exercises</h2>
<ol>
<li>What is the <code>re.sub</code> call in the <code>faker</code> script doing and why?</li>
</ol>
    </main>
    <footer>
  © 2024 <a href="https://third-bit.com/">Greg Wilson</a>
  &middot;
  <a href="../">home</a>
  &middot;
  <a href="https://github.com/gvwilson/sys-tutorial">repository</a>
  &middot;
  <a href="../license/">license</a>
</footer>

  </body>
</html>
